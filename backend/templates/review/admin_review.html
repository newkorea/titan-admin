<%inherit file="../admin_common/admin_frame.html"/>

<%block name="css">
<style>
  .flex-item {
    flex: 1;
}
  .country-logo {
    width: 20px;
    margin-left: 5px;
    margin-top: -5px;
}
.input-margin {
  font-size: 15px;
  display: flex;
}
.btn-store{
      text-align: right;
    margin-top: 20px;
    margin-bottom: 10px;
}
.item-store{
  border: solid 0px yellow;
  display: flex;
  margin-top: 12px;
}
  .review-section{
    padding: 12px;
    border: solid 1px #e3e0e6;
    width: 300px;
    border-radius: 5px;
    margin-left: 10px;
    margin-right: 10px;
  }
  .review-col2{
    margin-top: 10px;
  }
  .review-col3{
    margin-top: 10px;
  }
  .review-col4{
    margin-top: 10px;
  }
  .review-col5{
    margin-top: 3px;
  }
  .w100p{
    width: 100%;
  }
</style>
</%block>

<%block name="title">리뷰관리</%block>
<%block name="subtitle">사용자 메인페이지에 보이는 리뷰를 관리할 수 있습니다.</%block>

<%block name="content">

<div id="vue">
  <div class="box-body-input input-margin">
    <div class="flex-item">
      <input type="radio" name="sum" value="en" checked v-on:click='selectLanguage($event)'>
      <img class="country-logo" src='/static/image/usa.png'>
      <span>영어</span>
    </div>

    <div class="flex-item">
      <input type="radio" name="sum" value="ko" v-on:click='selectLanguage($event)'>
      <img class="country-logo" src='/static/image/korea.png'>
      <span>한국어</span>
    </div>

    <div class="flex-item">
      <input type="radio" name="sum" value="ja" v-on:click='selectLanguage($event)'>
      <img class="country-logo" src='/static/image/japan.png'>
      <span>일본어</span>
    </div>

    <div class="flex-item">
      <input type="radio" name="sum" value="zh" v-on:click='selectLanguage($event)'>
      <img class="country-logo" src='/static/image/china.png'>
      <span>중국어</span>
    </div>
  </div>

  <div class="btn-store">
    <button class="btn btn-fw success" v-on:click="addItem()">리뷰추가</button>
  </div>

  <div class="item-store">
    <!--template start-->
    <div class="review-section" v-for="item in items" v-if="item.idx == 1 || item.idx == 2 || item.idx == 3" :id="item.idx">
      <div class="review-col1">
        <label>평점</label>
        <select v-model="item.star" class="form-control" id="starbox" :name="item.id">
          <option v-for="test in tests" :value="test.value" >[[test.text]]</option>
        </select>
      </div>

      <div class="review-col2">
        <label>이름</label>
        <input type="text" class="form-control" id="input_name" name="username" placeholder="" :value="[[item.username]]">
      </div>
      <div class="review-col3">
        <label>내용</label>
         <textarea class="form-control" id="input_content" name="content" rows="3">[[item.content]]</textarea>
      </div>
      <div class="review-col4">
        <button class="w100p btn btn-fw warn" v-on:click="saveItem([[item.id]], [[item.idx]])">저장</button>
      </div>
      <div class="review-col5">
        <button class="w100p btn btn-fw white" v-on:click="deleteItem([[item.id]])">삭제</button>
      </div>
    </div>
    <!--template end-->
  </div>

  <div class="item-store">
    <!--template start-->
    <div class="review-section" v-for="item in items" v-if="item.idx == 4 || item.idx == 5 || item.idx == 6" :id="item.idx">
      <div class="review-col1">
        <label>평점</label>
        <select v-model="item.star" class="form-control" id="starbox" :name="item.id">
          <option v-for="test in tests" :value="test.value" >[[test.text]]</option>
        </select>
      </div>
      <div class="review-col2">
        <label>이름</label>
        <input type="text" class="form-control" id="name" name="username" placeholder="" :value="[[item.username]]">
      </div>
      <div class="review-col3">
        <label>내용</label>
         <textarea class="form-control" id="content" name="content" rows="3">[[item.content]]</textarea>
      </div>
      <div class="review-col4">
        <button class="w100p btn btn-fw warn" v-on:click="saveItem([[item.id]], [[item.idx]])">저장</button>
      </div>
      <div class="review-col5">
        <button class="w100p btn btn-fw white" v-on:click="deleteItem([[item.id]])">삭제</button>
      </div>
    </div>
    <!--template end-->
  </div>

</div>
</%block>

<%block name="js">
<script>

  var csrf_token = $('#csrf_token').html();
  var app = new Vue({
    el: '#vue',
    delimiters: ['[[', ']]'],
    created () {
      $.post( "/api_review_read", {
            csrfmiddlewaretoken: csrf_token,
            language: this.language,
        })
        .done(function( data ) {
            console.log(data.result);
            app.items = data.result;
            console.log("app.items->>", app.items);
            app.loadItem();
        });
    },
    data: {
      tests : [
          { value: 1, text: '★☆☆☆☆' },
          { value: 2, text: '★★☆☆☆' },
          { value: 3, text: '★★★☆☆' },
          { value: 4, text: '★★★★☆' },
          { value: 5, text: '★★★★★' },
      ],
      items: [],
      language: 'en'
    },
    methods: {
      // 언어 선택(state update) 및 내용 로드(based state)
      selectLanguage: function(e){
        var language = e.currentTarget.value;
        this.language = language;

        this.loadItem();
      },
      // 내용 로드(based state)
      loadItem: function(){
          vStar = new Array();
          var nId = 0;
          console.log('this->', this);
          console.log('items->', this.items);

          $.ajax({
              url: "/api_review_read",
              type: "POST",
              async: false, // ture: 비동기, false: 동기
              data: {
                  csrfmiddlewaretoken: csrf_token,
                  language: this.language,
              },
              dataType: "json",
              success: function(data){
                  console.log('data.result -> ', data.result);
                  app.items = data.result;
                  console.log('varvar', data.result[0].star);
                  for(var i = 0; i<data.result.length; i++){
                      nId++;
                      console.log(nId);
                      vStar[i] = data.result[i].star;
                      $('#'+nId).find('select[id=starbox]').val(vStar[i]).prop("selected", "selected");
                  }
                  console.log('vStar ->', vStar);
              }
          });
      },
      // 아이템 삭제 후 내용 로드(based state)
      deleteItem: function(seq){
        var seq = seq[0][0];
        console.log('seq -> ', seq);
        $.post( "/api_review_del", {
            csrfmiddlewaretoken: csrf_token,
            seq: seq,
        })
        .done(function( data ) {
            if (data.result == '200') {
                Swal.fire({
                    title: '삭제완료',
                    text: '정상적으로 삭제되었습니다.',
                    type: 'success',
                    confirmButtonColor: swalColor('error')
                })
                app.loadItem();
            }
        });
      },
      addItem: function(){
          if(this.items.length == 6){
              Swal.fire({
                  title: '알림',
                  text: '리뷰추가는 6개까지 가능합니다.',
                  type: 'error',
                  confirmButtonColor: swalColor('error')
              });
              return 0;
          }
          $.ajax({
              url: "/api_review_count",
              type: "POST",
              async: false, // ture: 비동기, false: 동기
              data: {
                  csrfmiddlewaretoken: csrf_token,
                  language: this.language,
              },
              dataType: "json",
              success: function(data){
                  console.log(data.result);
                  length = data.result;
              }
          });

          console.log('this.items -> ', this.items.length);
          console.log('length -> ', length);

          if(length < this.items.length){
              Swal.fire({
                  title: '알림',
                  text: '기존에 작성하던 리뷰를 저장 후에 추가해주세요.',
                  type: 'error',
                  confirmButtonColor: swalColor('error')
              });
              return 0;
          }

        var tmp = {
          content: '',
          id: 0,
          idx: this.items.length + 1,
          star: 1,
          username: ''
        }

        this.items.push(tmp);

      },
      // 내용 업데이트 및 삽입
      saveItem: function(seq, idx){
        var seq = seq[0][0];
        var language = this.language;
        var starbox = $('#'+idx).find('#starbox option:selected').val();
        if(starbox == '★☆☆☆☆')
            starbox = '1';
        else if(starbox == '★★☆☆☆')
            starbox = '2';
        else if(starbox == '★★★☆☆')
            starbox = '3';
        else if(starbox == '★★★★☆')
            starbox = '4';
        else if(starbox == '★★★★★')
            starbox = '5';

        var username = $('#'+idx).find('input[name=username]').val();
        var content = $('#'+idx).find('textarea[name=content]').val();
        if(username == ''){
            $('#'+idx).find('input[name=username]').focus();
            return 0;
          }
       if(content == ''){
           $('#'+idx).find('textarea[name=content]').focus();
           return 0;
       }

        console.log('--------------------------------');
        console.log('seq -> ', seq);
        console.log('language -> ', language);
        console.log('starbox -> ', starbox);
        console.log('username -> ', username);
        console.log('content -> ', content);
        console.log('--------------------------------');

        $.post( "/api_review_save", {
            csrfmiddlewaretoken: csrf_token,
            seq: seq,
            username: username,
            content: content,
            starbox: starbox,
            language: language,
        })
        .done(function( data ) {
            if (data.result == '200') {
                Swal.fire({
                    title: '저장완료',
                    text: '정상적으로 저장되었습니다.',
                    type: 'success',
                    confirmButtonColor: "#22b66e"
                }).then(function (result) {
                        if (result.value) {
                            app.loadItem();
                        }
                    }
                )
            }
        });

      },
    }
  })
</script>
</%block>
