import json
import datetime
import smtplib
from dateutil.relativedelta import relativedelta
from django.shortcuts import render
from django.shortcuts import redirect
from django.http import HttpResponse, JsonResponse
from django.views.decorators.csrf import csrf_protect
from django.db import connections
from django.db import transaction
from django.db.models import Max
from django.core.exceptions import ObjectDoesNotExist
from pytz import timezone
from urllib.parse import quote
from urllib.parse import unquote
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from backend.models import *
from backend.models_radius import Radcheck
from backend.djangoapps.common.views import *
from backend.djangoapps.common.swal import get_swal
from django.utils import translation
from backend.djangoapps.common.payletter import Payletter
from backend.djangoapps.common.payletter_global import PayletterGlobal
from backend.djangoapps.common.paybox import Paybox


# 무통장내역 렌더링 (2020-03-18)
@allow_admin
def account_history(request):
    return render(request, 'admin/price_bank.html')


# 계좌관리 렌더링 (2020-03-18)
@allow_admin
def account_setting(request):
    return render(request, 'admin/price_account.html')


# 결제관리 페이지 렌더링 (2020-03-18)
@allow_admin
def price(request):
    return render(request, 'admin/price_payment.html')


# (2020-03-18)
@allow_admin
def api_read_payment(request):

    # datatables 기본 파라미터
    start = int(request.POST.get('start'))
    length = int(request.POST.get('length'))
    draw = int(request.POST.get('draw'))
    orderby_col = int(request.POST.get('order[0][column]'))
    orderby_opt = request.POST.get('order[0][dir]')

    # 검색필터 파라미터
    email = request.POST.get('email')
    session = request.POST.get('session')
    month = request.POST.get('month')
    refund = request.POST.get('refund')
    regist_start = request.POST.get('regist_start')
    regist_end = request.POST.get('regist_end')

    # 로깅 (datatables 기본 파라미터)
    print('DEBUG -> start : ', start)
    print('DEBUG -> length : ', length)
    print('DEBUG -> draw : ', draw)
    print('DEBUG -> orderby_col : ', orderby_col)
    print('DEBUG -> orderby_opt : ', orderby_opt)

    # 로깅 (검색필터 파라미터)
    print('DEBUG -> email : ', email)
    print('DEBUG -> session : ', session)
    print('DEBUG -> month : ', month)
    print('DEBUG -> refund : ', refund)
    print('DEBUG -> regist_start : ', regist_start)
    print('DEBUG -> regist_end : ', regist_end)

    # where 절 필터링 생성
    wc = ' where 1=1 '
    if email != '':
        wc += " and y.email like '%{email}%' ".format(email=email)
    if session != '0':
        wc += " and x.session = '{session}' ".format(session=session)
    if month != '0':
        wc += " and x.month_type = '{month}' ".format(month=month)
    if refund != '0':
        wc += " and x.refund_yn = '{refund}' ".format(refund=refund)
    if regist_start != '':
        wc += '''
            and x.regist_date >= '{regist_start}'
        '''.format(regist_start=regist_start)
    if regist_end != '':
        wc += '''
            and x.regist_date < '{regist_end}'
        '''.format(regist_end=regist_end)

    # order by 리스트
    column_name = [
        'x.id',
        'x.tid',
        'x.pgcode',
        'x.product_name',
        'x.krw',
        'x.usd',
        'x.cny',
        'y.email',
        'x.refund_yn',
        'x.regist_date',
        'x.refund_date'
    ]

    # 데이터테이블즈 - 카운팅 쿼리
    with connections['default'].cursor() as cur:
        query = '''
            select count(*)
            from tbl_price_history x
            join tbl_user y
            on x.user_id = y.id
            {wc}
        '''.format(wc=wc)
        # print(query)
        cur.execute(query)
        rows = cur.fetchall()
        total = rows[0][0]
        # print('DEBUG -> total : ', total)

    # 데이터테이블즈 - 메인 쿼리
    with connections['default'].cursor() as cur:
        query = '''
            select  x.id,
            		x.tid,
            		x.pgcode,
            		x.product_name,
            		x.krw as krw,
            		x.usd as usd,
            		x.cny as cny,
            		x.taxfree_amount,
            		x.tax_amount,
            		y.email,
            		x.autopay_flag,
            		x.refund_yn,
            		x.regist_date,
            		x.refund_date,
            		x.auto_end_date,
                    concat(x.id, '+', x.refund_yn) as refund
            from tbl_price_history x
            join tbl_user y
            on x.user_id = y.id
            {wc}
            order by {orderby_col} {orderby_opt}
            limit {start}, 10
        '''.format(
            wc=wc,
            orderby_col=column_name[orderby_col],
            orderby_opt=orderby_opt,
            start=start,
            end=start+length-1
        )
        print(query)
        cur.execute(query)
        rows = dictfetchall(cur)

    ret = {
        "recordsTotal": total,
        "recordsFiltered": total,
        "draw": draw,
        "data": rows
    }
    return JsonResponse(ret)


# (2020-03-18)
@allow_admin
def api_update_refund(request):

    # 파라미터 로드
    id = request.POST.get('id')

    # 결제 테이블 조회
    tph = TblPriceHistory.objects.get(id=id)
    krw = tph.krw
    usd = tph.usd
    cny = tph.cny
    tid = tph.tid
    user_id = tph.user_id
    pgcode = tph.pgcode
    
    session = str(tph.session)
    month_type = str(tph.month_type)
    user_id = tph.user_id
    
    # 파라미터 로깅
    print('DEBUG -> id : ', id)
    print('DEBUG -> krw : ', krw)
    print('DEBUG -> usd : ', usd)
    print('DEBUG -> cny : ', cny)
    print('DEBUG -> tid : ', tid)
    print('DEBUG -> user_id : ', user_id)
    print('DEBUG -> pgcode : ', pgcode)

    # 사용자 객체
    user = TblUser.objects.get(id=user_id)
    email = user.email

    # 국내환불
    if krw != None:
        p = Payletter(settings.PAYLETTER_MODE)
        res = p.payments_cancel(pgcode, user_id, tid, krw)
        # 환불 성공
        if res == 200:
            tph.refund_yn = 'Y'
            tph.refund_date = datetime.datetime.now()
            tph.save()
            initServiceTime(user_id)
            #refundPayment(user_id, session, month_type)
            title, text = get_swal('PAYMENT_SUCCESS')
            return JsonResponse({'result': 200, 'title': title, 'text': text})
        else:
            # 환불 실패
            title, text = get_swal('PAYMENT_ERROR')
            return JsonResponse({'result': 500, 'title': title, 'text': text})
    # 해외환불
    elif usd != None:
        p = PayletterGlobal(settings.PAYLETTER_MODE)
        res = p.payments_cancel(pgcode, user_id, tid, usd)
        # 환불 성공
        if res == 200:
            tph.refund_yn = 'Y'
            tph.refund_date = datetime.datetime.now()
            tph.save()
            initServiceTime(user_id)
            #refundPayment(user_id, session, month_type)
            title, text = get_swal('PAYMENT_SUCCESS')
            return JsonResponse({'result': 200, 'title': title, 'text': text})
        elif res == 400:
            # 환불 실패 (이미 처리된 트랜잭션)
            title, text = get_swal('PAYMENT_ALREADY')
            return JsonResponse({'result': 500, 'title': title, 'text': text})
        else:
            # 환불 실패
            title, text = get_swal('PAYMENT_ERROR')
            return JsonResponse({'result': 500, 'title': title, 'text': text})
    # 위챗환불
    elif cny != None:
        p = Paybox(settings.PAYBOX_MODE)
        token = p.load_token()
        if token != 500:
            res = p.payments_cancel(pgcode, user_id, tid, cny, token)
            # 환불성공
            if res != 500:
                tph.refund_yn = 'Y'
                tph.refund_date = datetime.datetime.now()
                tph.save()
                #initServiceTime(user_id)
                refundPayment(user_id, session, month_type)
                title, text = get_swal('PAYMENT_SUCCESS')
                return JsonResponse({'result': 200, 'title': title, 'text': text})
            else:
                title, text = get_swal('PAYMENT_ERROR')
                return JsonResponse({'result': 500, 'title': title, 'text': text})
        else:
            title, text = get_swal('PAYMENT_ERROR')
            return JsonResponse({'result': 500, 'title': title, 'text': text})
    else:
        title, text = get_swal('PAYMENT_UNKNOWN')
        return JsonResponse({'result': 500, 'title': title, 'text': text})


# (2020-03-18)
@allow_admin
def api_update_account(request):
    person_name = request.POST.get('person_name')
    bank_name = request.POST.get('bank_name')
    bank_number = request.POST.get('bank_number')
    try:
        bank = TblBankAccount.objects.get(type='main')
        bank.person_name = person_name
        bank.bank_name = bank_name
        bank.bank_number = bank_number
        bank.save()
        title, text = get_swal('SUCCESS_ACCOUNT')
        return JsonResponse({'result': 200, 'title': title, 'text': text})
    except BaseException as err:
        title, text = get_swal('UNKNOWN_ERROR')
        return JsonResponse({'result': 500, 'title': title, 'text': text})



# (2020-03-18)
@allow_admin
def api_read_account(request):
    try:
        bank = TblBankAccount.objects.get(type='main')
        person_name = bank.person_name
        bank_name = bank.bank_name
        bank_number = bank.bank_number
        send = {
            'person_name': person_name,
            'bank_name': bank_name,
            'bank_number': bank_number
        }
        return JsonResponse({'result': 200, 'bank': send})
    except BaseException as err:
        title, text = get_swal('UNKNOWN_ERROR')
        return JsonResponse({'result': 500, 'title': title, 'text': text})


# (2020-03-18)
@allow_admin
def api_read_ready_count(request):
    history = TblSendHistory.objects.filter(status='R')
    ready_count = len(history)
    return JsonResponse({'result': 200, 'ready_count': ready_count})


# (2020-03-18)
@allow_admin
def api_read_bank(request):

    # datatables 기본 파라미터
    start = int(request.POST.get('start'))
    length = int(request.POST.get('length'))
    draw = int(request.POST.get('draw'))
    orderby_col = int(request.POST.get('order[0][column]'))
    orderby_opt = request.POST.get('order[0][dir]')

    # 검색필터 파라미터
    number = request.POST.get('number')
    email = request.POST.get('email')
    username = request.POST.get('username')
    session = request.POST.get('session')
    month = request.POST.get('month')
    status = request.POST.get('status')
    regist_start = request.POST.get('regist_start')
    regist_end = request.POST.get('regist_end')

    # 로깅 (datatables 기본 파라미터)
    print('DEBUG -> start : ', start)
    print('DEBUG -> length : ', length)
    print('DEBUG -> draw : ', draw)
    print('DEBUG -> orderby_col : ', orderby_col)
    print('DEBUG -> orderby_opt : ', orderby_opt)

    # 로깅 (검색필터 파라미터)
    print('DEBUG -> number : ', number)
    print('DEBUG -> email : ', email)
    print('DEBUG -> username : ', username)
    print('DEBUG -> session : ', session)
    print('DEBUG -> month : ', month)
    print('DEBUG -> status : ', status)
    print('DEBUG -> regist_start : ', regist_start)
    print('DEBUG -> regist_end : ', regist_end)

    # where 절 필터링 생성
    wc = ' where 1=1 '
    if number != '':
        wc += " and x.id = '{number}' ".format(number=number)
    if email != '':
        wc += " and y.email like '%{email}%' ".format(email=email)
    if username != '':
        wc += " and y.username like '%{username}%' ".format(username=username)
    if session != '0':
        wc += " and x.session = '{session}' ".format(session=session)
    if month != '0':
        wc += " and x.month_type = '{month}' ".format(month=month)
    if status != '0':
        wc += " and x.status = '{status}' ".format(status=status)
    if regist_start != '':
        wc += '''
            and x.regist_date >= '{regist_start}'
        '''.format(regist_start=regist_start)
    if regist_end != '':
        wc += '''
            and x.regist_date < '{regist_end}'
        '''.format(regist_end=regist_end)

    # order by 리스트
    column_name = [
        'x.id',
        'y.email',
        'y.username',
        'x.session',
        'x.month_type',
        'x.krw'
    ]

    # 데이터테이블즈 - 카운팅 쿼리
    with connections['default'].cursor() as cur:
        query = '''
            select count(*)
            from tbl_send_history x
            join tbl_user y
            on x.user_id = y.id
            {wc}
        '''.format(wc=wc)
        # print(query)
        cur.execute(query)
        rows = cur.fetchall()
        total = rows[0][0]
        # print('DEBUG -> total : ', total)

    # 데이터테이블즈 - 메인 쿼리
    with connections['default'].cursor() as cur:
        query = '''
            select  x.id,
            		y.email,
            		y.username,
            		x.session,
            		x.month_type,
            		x.krw,
            		x.status as status,
            		concat(x.status, '@', x.id, '@', y.username, '@', x.product_name, '@', x.krw) as cancel,
                    DATE_FORMAT(x.cancel_date, "%Y-%m-%d %H:%i:%S") as cancel_date,
            		concat(x.status, '@', x.id, '@', y.username, '@', x.product_name, '@', x.krw) as accept,
                    DATE_FORMAT(x.accept_date, "%Y-%m-%d %H:%i:%S") as accept_date,
            		concat(x.status, '@', x.id, '@', y.username, '@', x.product_name, '@', x.krw) as refund,
                    DATE_FORMAT(x.refund_date, "%Y-%m-%d %H:%i:%S") as refund_date,
            		x.type
            from tbl_send_history x
            join tbl_user y
            on x.user_id = y.id
            {wc}
            order by {orderby_col} {orderby_opt}
            limit {start}, 10
        '''.format(
            wc=wc,
            orderby_col=column_name[orderby_col],
            orderby_opt=orderby_opt,
            start=start
        )
        print(query)
        cur.execute(query)
        rows = dictfetchall(cur)

    ret = {
        "recordsTotal": total,
        "recordsFiltered": total,
        "draw": draw,
        "data": rows
    }
    return JsonResponse(ret)


# (2020-03-18)
@allow_admin
def api_create_bank(request):
    note_email = request.POST.get('note_email')
    note_session = request.POST.get('note_session')
    note_month = request.POST.get('note_month')
    note_type = request.POST.get('note_type')

    print("note_email -> ", note_email)
    print("note_session -> ", note_session)
    print("note_month -> ", note_month)
    print("note_type -> ", note_type)

    try:
        user = TblUser.objects.get(email=note_email)
    except BaseException as err:
        title, text = get_swal('NOT_USER')
        return JsonResponse({'result': 500, 'title': title, 'text': text})

    price = getProductPirce(note_session, note_month, 'KRW')
    product_name = makeProductName(note_session, note_month)

    try:
        sh = TblSendHistory(
            user_id = user.id,
            product_name = product_name,
            session = note_session,
            month_type = note_month,
            krw = price,
            usd = None,
            jpy = None,
            cny = None,
            status = 'R',
            type = note_type,
            regist_date = datetime.datetime.now(),
            accept_date = None,
            cancel_date = None,
            refund_date = None)
        sh.save()
        title, text = get_swal('SUCCESS_BANK')
        return JsonResponse({'result': 200, 'title': title, 'text': text})
    except BaseException as err:
        title, text = get_swal('UNKNOWN_ERROR')
        return JsonResponse({'result': 500, 'title': title, 'text': text})


# (2020-03-18)
@allow_admin
def api_update_bank(request):
    id = request.POST.get('id')
    type = request.POST.get('type')

    try:
        history = TblSendHistory.objects.get(id=id)
        session = str(history.session)
        month_type = str(history.month_type)
        user_id = history.user_id

        history.status = type
        if type == 'C':
            history.cancel_date = datetime.datetime.now()
        elif type == 'A':
            history.accept_date = datetime.datetime.now()
            # 시간충전
            giveServiceTime(user_id, session, month_type)
        elif type == 'Z':
            history.refund_date = datetime.datetime.now()
            # 시간초기화
            #initServiceTime(user_id)
            refundPayment(user_id, session, month_type)
        history.save()

        title, text = get_swal('SUCCESS_COMMON')
        return JsonResponse({'result': 200, 'title': title, 'text': text})
    except BaseException as err:
        title, text = get_swal('UNKNOWN_ERROR')
        return JsonResponse({'result': 500, 'title': title, 'text': text})

# (2022-08-08)
def refundPayment(user_id, session, month_type):
    print("Recall -> ", "RefundPayment")
    # 유저객체 획득
    u1 = TblUser.objects.get(id = user_id)
    email = u1.email

    # Radcheck의 Cleartext-Password가 없을 경우 생성
    #rr = Radcheck.objects.using('radius').filter(
    #    username = email,
    #    attribute = 'Cleartext-Password')
    #if len(rr) == 0:
    #    r1 = Radcheck(
    #        username=email,
    #        attribute='Cleartext-Password',
    #        op=':=',
    #        value=str(uuid.uuid4()).replace('-', '')
    #    )
    #    r1.save(using='radius')
    # Radcheck의 session 변경 (merge 로직)
    rc = Radcheck.objects.using('radius').filter(
        username = email,
        attribute = 'Simultaneous-Use'
    )
    #if len(rc) == 0:
    #    rci = Radcheck(
    #        username = email,
    #        attribute = 'Simultaneous-Use',
    #        op = ':=',
    #        value = int(1)
    #    )
    #    rci.save(using='radius')
    #else:
    #    rcu = rc.first()
    #    rcu.value = int(1)
    #    rcu.save(using='radius')

    print("Email -> ", email)
    # Radcheck의 time 변경 (merge 로직)
    rce = Radcheck.objects.using('radius').filter(
        username = email,
        attribute = 'Expiration'
    )
    my_time = my_expire_time(email, 'datetime')
    print("My Time -> ", my_time)
    if len(rce) == 0:
        rcei = Radcheck(
            username = email,
            attribute = 'Expiration',
            op = ':=',
            value = '01 Jan 2010 00:00:00 KST'
        )
        rcei.save(using='radius')
        prev_time = ''
        prev_time_rad = ''
    else:
        if my_time > datetime.datetime.now():
            rcu = rc.first()
            if rcu.value != session :
                diff = my_time - datetime.datetime.now()
                print("Diff Days -> ", diff.days)
                if int(rcu.value) == 1:
                    new_days = int((diff.days + 1) * 270 / 460) + 1
                else :
                    new_days = int((diff.days + 1) * 460 / 270) + 1
                print("New Days -> ", new_days)
                if int(month_type) == 1:
                    add_time = datetime.datetime.now() + datetime.timedelta(new_days) - relativedelta(months=1)
                elif int(month_type) == 2:
                    add_time = datetime.datetime.now() + datetime.timedelta(new_days) - relativedelta(months=2)
                elif int(month_type) == 3:
                    add_time = datetime.datetime.now() + datetime.timedelta(new_days) - relativedelta(months=3)
                elif int(month_type) == 6:
                    add_time = datetime.datetime.now() + datetime.timedelta(new_days) - relativedelta(months=6)
                elif int(month_type) == 12:
                    add_time = datetime.datetime.now() + datetime.timedelta(new_days) - relativedelta(months=12)
                
                rcu = rc.first()
                rcu.value = int(session)
                rcu.save(using='radius')
            else :    
                if int(month_type) == 1:
                    add_time = my_time - relativedelta(months=1)
                elif int(month_type) == 2:
                    add_time = my_time - relativedelta(months=2)
                elif int(month_type) == 3:
                    add_time = my_time - relativedelta(months=3)
                elif int(month_type) == 6:
                    add_time = my_time - relativedelta(months=6)
                elif int(month_type) == 12:
                    add_time = my_time - relativedelta(months=12)
            
            print("Added Time -> ", add_time)
            
            rceu = rce.first()
            prev_time_rad = rceu.value
            prev_time = dec_radius_time(rceu.value)
            after_time = add_time
            after_time_rad = change_date(add_time)
            
            rceu.value = change_date(add_time)
            rceu.save(using='radius')
        else :
            rceu = rce.first()
            prev_time_rad = rceu.value
            prev_time = dec_radius_time(rceu.value)
            after_time = '2010-01-01 00:00:00'
            after_time_rad = '01 Jan 2010 00:00:00 KST'
            
            rceu.value = '01 Jan 2010 00:00:00 KST'
            rceu.save(using='radius')
            
    #time_diff = after_time - prev_time
    #time_diff = round((time_diff).total_seconds()/60)
    
    reason = "환불"
    st = TblServiceTime(
        user_id = user_id,
        prev_time = prev_time,
        prev_time_rad = prev_time_rad,
        after_time = after_time,
        after_time_rad = after_time_rad,
        diff = reason,
        reason = reason,
        regist_date = datetime.datetime.now())
    st.save()
# (2022-08-08)
def change_date(old_date):
    try:
        return old_date.strftime("%d %b %Y %H:%M:%S") + " KST"
    except BaseException:
        return None

# (2022.08.08)
def my_expire_time(email, return_type):
    try:
        r = Radcheck.objects.using('radius').get(
            username=email,
            attribute='Expiration'
        )
        expire_time = r.value
        expire_time = dec_radius_time(expire_time)
        if return_type == 'datetime':
            return expire_time
        elif return_type == 'str':
            return expire_time.strftime("%Y-%m-%d %H:%M:%S")
    except BaseException:
        return None
        
# (2020-03-18)
@allow_admin
def api_read_ready_data(request):
    ready_list = ''
    history = TblSendHistory.objects.filter(status='R')
    total = len(history)
    for h in history:
        ready_list += str(h.id) + '  '
    return JsonResponse({'result': 200, 'ready_list': ready_list, 'total': total})
