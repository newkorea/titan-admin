#원격승인 500,600 설치바로전코드
import json
import datetime
import smtplib
from dateutil.relativedelta import relativedelta
from django.shortcuts import render
from django.shortcuts import redirect
from django.http import HttpResponse, JsonResponse
from django.views.decorators.csrf import csrf_protect
from django.db import connections
from django.db import transaction
from django.db.models import Max
from django.core.exceptions import ObjectDoesNotExist
from pytz import timezone
from urllib.parse import quote
from urllib.parse import unquote
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from backend.models import *
from backend.models_radius import Radcheck
from backend.djangoapps.common.views import *
from backend.djangoapps.common.swal import get_swal
from django.utils import translation
from backend.djangoapps.common.payletter import Payletter
from backend.djangoapps.common.payletter_global import PayletterGlobal
from backend.djangoapps.common.paybox import Paybox
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
from django.shortcuts import get_object_or_404

#원격 자동승인프로그램용 API 25-02-19
from django.http import JsonResponse
import json
import os
# from datetime import datetime, timedelta
from django.views.decorators.csrf import csrf_exempt
from django.conf import settings  # ✅ settings.py에서 API_SECRET_KEY 가져오기
from backend.models import TblPaymentRequest  # ✅ `backend.` 추가 
from django.test import RequestFactory
from importlib import import_module  # ✅ 동적 import 사용
from django.contrib.sessions.middleware import SessionMiddleware
from django.contrib.sessions.backends.db import SessionStore  # ✅ 세션 저장소 추가
import pytz
from django.utils.timezone import now


@csrf_exempt
def approve_payment_api(request):
    if request.method == "POST":
        try:
            raw_body = request.body.decode('utf-8')
            data = json.loads(raw_body)
            ip_address = request.META.get('REMOTE_ADDR')
            user_agent = request.META.get('HTTP_USER_AGENT', '')

            payment_type = data.get("payment_type")
            payment_amount = data.get("payment_amount")
            payment_time = data.get("payment_time")

            log_entry = TblPaymentApiLog.objects.create(
                payment_type=payment_type,
                payment_amount=payment_amount,
                payment_time=payment_time,
                ip_address=ip_address,
                user_agent=user_agent,
                raw_payload=raw_body,
                result_message='수신 대기 중',
                status='PENDING',
                request_time=datetime.datetime.now()
            )
        except Exception as e:
            TblPaymentApiLog.objects.create(
                payment_type=None,
                payment_amount=None,
                payment_time=None,
                ip_address=request.META.get('REMOTE_ADDR'),
                user_agent=request.META.get('HTTP_USER_AGENT', ''),
                raw_payload=request.body.decode('utf-8'),
                result_message=str(e),
                status='ERROR',
                request_time=datetime.datetime.now()
            )
            return JsonResponse({"status": "error", "message": f"서버 오류: {str(e)}"}, status=500)

        try:
            auth_header = request.headers.get("Authorization", "")
            if auth_header != f"Bearer {settings.API_SECRET_KEY}":
                log_entry.result_message = "인증 실패"
                log_entry.save()
                return JsonResponse({"status": "error", "message": "인증 실패"}, status=403)

            type_mapping = {"alipay": "A", "wechat": "W"}
            mapped_type = type_mapping.get(payment_type.lower())
            if not mapped_type:
                log_entry.result_message = "잘못된 결제 유형"
                log_entry.save()
                return JsonResponse({"status": "error", "message": "잘못된 결제 유형"}, status=400)

            cst = pytz.timezone('Asia/Shanghai')
            kst = pytz.timezone('Asia/Seoul')
            today_cst = datetime.datetime.now(cst).date()

            try:
                api_datetime_cst = datetime.datetime.combine(
                    today_cst,
                    datetime.datetime.strptime(payment_time, "%H:%M").time()
                )
            except ValueError:
                log_entry.result_message = f"잘못된 시간 형식: {payment_time}"
                log_entry.status = "ERROR"
                log_entry.save()
                return JsonResponse({"status": "error", "message": "잘못된 시간 형식"}, status=501)

            api_datetime_cst = cst.localize(api_datetime_cst)
            api_datetime_kst = api_datetime_cst.astimezone(kst)
            api_datetime_naive = api_datetime_kst.replace(tzinfo=None)

            now_naive = datetime.datetime.now()
            if api_datetime_naive > now_naive:
                api_datetime_naive -= datetime.timedelta(days=1)

            existing_payment = TblSendHistory.objects.filter(
                type=mapped_type,
                krw=str(payment_amount),
                api_date=api_datetime_naive,
                status="A"
            ).exists()

            if existing_payment:
                log_entry.result_message = "이미 승인된 결제 정보입니다."
                log_entry.save()
                return JsonResponse({"status": "error", "message": "이미 승인된 결제 정보입니다."}, status=400)

            payment_request = TblSendHistory.objects.filter(
                type=mapped_type,
                krw=str(payment_amount),
                status="R"
            ).order_by('-regist_date').first()

            if not payment_request:
                same_amount_diff_time = TblSendHistory.objects.filter(
                    type=mapped_type,
                    krw=str(payment_amount),
                    status="R"
                ).exclude(regist_date__minute=api_datetime_naive.minute).exists()

                if same_amount_diff_time:
                    log_entry.result_message = "같은 금액의 승인대기 있지만 시간이 다름"
                    log_entry.save()
                    return JsonResponse({"status": "error", "message": "같은 금액의 승인대기 있지만 시간이 다름"}, status=501)

                same_time_diff_amount = TblSendHistory.objects.filter(
                    type=mapped_type,
                    status="R",
                    regist_date__minute=api_datetime_naive.minute
                ).exclude(krw=str(payment_amount)).exists()

                if same_time_diff_amount:
                    log_entry.result_message = "같은 시간의 승인대기 있지만 금액 다름"
                    log_entry.save()
                    return JsonResponse({"status": "error", "message": "같은 시간의 승인대기 있지만 금액 다름"}, status=502)

                completely_different = TblSendHistory.objects.filter(
                    type=mapped_type,
                    status="R"
                ).exclude(krw=str(payment_amount)).exclude(regist_date__minute=api_datetime_naive.minute).exists()

                if completely_different:
                    log_entry.result_message = "금액과 시간이 모두 다름"
                    log_entry.save()
                    return JsonResponse({"status": "error", "message": "금액과 시간이 모두 다름"}, status=503)

                other_type = TblSendHistory.objects.exclude(type=mapped_type).filter(status="R")
                for other in other_type:
                    time_match = other.regist_date.minute == api_datetime_naive.minute
                    amount_match = other.krw == str(payment_amount)

                    if time_match and amount_match:
                        log_entry.result_message = "시간·금액 동일하지만 결제방식 다름"
                        log_entry.save()
                        return JsonResponse({"status": "error", "message": "시간·금액 동일하지만 결제방식 다름"}, status=600)
                    if not time_match and amount_match:
                        log_entry.result_message = "금액은 같지만 시간이 다르고 결제방식도 다름"
                        log_entry.save()
                        return JsonResponse({"status": "error", "message": "시간 다르고 결제방식도 다름"}, status=601)
                    if time_match and not amount_match:
                        log_entry.result_message = "시간은 같지만 금액 다르고 결제방식도 다름"
                        log_entry.save()
                        return JsonResponse({"status": "error", "message": "금액 다르고 결제방식도 다름"}, status=602)
                    if not time_match and not amount_match:
                        log_entry.result_message = "시간·금액·방식 모두 다름"
                        log_entry.save()
                        return JsonResponse({"status": "error", "message": "시간·금액·방식 모두 다름"}, status=603)

                log_entry.result_message = "일치하는 결제 요청 없음"
                log_entry.save()
                return JsonResponse({"status": "error", "message": "승인대기하는 결제 요청 없음"}, status=404)

            db_payment_time = payment_request.regist_date
            time_difference = (api_datetime_naive - db_payment_time).total_seconds()

            if time_difference < -90:
                log_entry.result_message = "결제 시간이 DB보다 90초 이상 빠름"
                log_entry.save()
                return JsonResponse({"status": "error", "message": "결제 시간이 DB보다 90초 이상 빠를 수 없습니다."}, status=400)

            if time_difference > 180:
                log_entry.result_message = "결제 시간이 DB보다 3분 초과 늦음"
                log_entry.save()
                return JsonResponse({"status": "error", "message": "결제 시간이 DB보다 3분 초과로 늦습니다."}, status=400)

            user_id = payment_request.user_id
            session = str(payment_request.session)
            month_type = str(payment_request.month_type)

            with transaction.atomic():
                giveServiceTime(user_id, session, month_type)
                payment_request.status = "A"
                payment_request.accept_date = datetime.datetime.now()
                payment_request.api_date = api_datetime_naive
                payment_request.save()

                log_entry.status = "APPROVED"
                log_entry.result_message = "결제 승인 완료"
                log_entry.save()

            return JsonResponse({"status": "success", "message": "결제 승인 완료"})

        except Exception as e:
            log_entry.result_message = f"서버 오류: {str(e)}"
            log_entry.status = "ERROR"
            log_entry.save()
            return JsonResponse({"status": "error", "message": f"서버 오류: {str(e)}"}, status=500)

    return JsonResponse({"status": "error", "message": "잘못된 요청 방식"}, status=405)

# 관리자 페이지에서 API 로그 확인 뷰(26-06-05)
# 기존 API: JSON 반환용 => 유지합니다
@allow_admin
def api_view_payment_logs(request):
    start = int(request.GET.get('start', 0))
    length = int(request.GET.get('length', 10))
    draw = int(request.GET.get('draw', 1))

    logs = TblPaymentApiLog.objects.all().order_by('-request_time')
    total = logs.count()
    logs = logs[start:start+length]

    data = []
    for log in logs:
        data.append({
            'id': log.id,
            'request_time': log.request_time.strftime("%Y-%m-%d %H:%M:%S"),
            'payment_type': log.payment_type,
            'payment_amount': log.payment_amount,
            'payment_time': log.payment_time,
            'ip_address': log.ip_address,
            'status': log.status,
            'result_message': log.result_message,
            'user_agent': log.user_agent[:100],
        })

    return JsonResponse({
        "draw": draw,
        "recordsTotal": total,
        "recordsFiltered": total,
        "data": data
    })

    # 관리자 HTML 페이지 반환용 => 신규 추가

# views.py (예시)
# backend/djangoapps/price/views.py

from django.shortcuts import render
from backend.models import TblPaymentApiLog  # 또는 정확한 경로

def admin_payment_logs_page(request):
    logs = TblPaymentApiLog.objects.all().order_by('-request_time')
    return render(request, 'admin/view_payment_logs.html', {'logs': logs})





# 무통장내역 렌더링 (2020-03-18)
@allow_admin
def account_history(request):
    return render(request, 'admin/price_bank.html')


# 계좌관리 렌더링 (2020-03-18)
@allow_admin
def account_setting(request):
    return render(request, 'admin/price_account.html')


# 결제관리 페이지 렌더링 (2020-03-18)
@allow_admin
def price(request):
    return render(request, 'admin/price_payment.html')


# (2020-03-18)
@allow_admin
def api_read_payment(request):

    # datatables 기본 파라미터
    start = int(request.POST.get('start'))
    length = int(request.POST.get('length'))
    draw = int(request.POST.get('draw'))
    orderby_col = int(request.POST.get('order[0][column]'))
    orderby_opt = request.POST.get('order[0][dir]')

    # 검색필터 파라미터
    email = request.POST.get('email')
    session = request.POST.get('session')
    month = request.POST.get('month')
    refund = request.POST.get('refund')
    type = request.POST.get('type')
    regist_start = request.POST.get('regist_start')
    regist_end = request.POST.get('regist_end')

    # 로깅 (datatables 기본 파라미터)
    #print('DEBUG -> start : ', start)
    #print('DEBUG -> length : ', length)
    #print('DEBUG -> draw : ', draw)
    #print('DEBUG -> orderby_col : ', orderby_col)
    #print('DEBUG -> orderby_opt : ', orderby_opt)

    # 로깅 (검색필터 파라미터)
    #print('DEBUG -> email : ', email)
    #print('DEBUG -> session : ', session)
    #print('DEBUG -> month : ', month)
    #print('DEBUG -> refund : ', refund)
    #print('DEBUG -> regist_start : ', regist_start)
    #print('DEBUG -> regist_end : ', regist_end)

    # where 절 필터링 생성
    wc = ' where 1=1 '
    if email != '':
        wc += " and y.email like '%{email}%' ".format(email=email)
    if session != '0':
        wc += " and x.session = '{session}' ".format(session=session)
    if month != '0':
        wc += " and x.month_type = '{month}' ".format(month=month)
    if type != '':
        wc += " and x.pgcode = '{type}' ".format(type=type)
    if refund != '0':
        wc += " and x.refund_yn = '{refund}' ".format(refund=refund)
    if regist_start != '':
        wc += '''
            and x.regist_date >= '{regist_start}'
        '''.format(regist_start=regist_start)
    if regist_end != '':
        wc += '''
            and x.regist_date < '{regist_end}'
        '''.format(regist_end=regist_end)

    # order by 리스트
    column_name = [
        'x.id',
        'x.tid',
        'x.pgcode',
        'x.product_name',
        'x.krw',
        'x.usd',
        'x.cny',
        'y.email',
        'x.refund_yn',
        'x.regist_date',
        'x.refund_date'
    ]

    # 데이터테이블즈 - 카운팅 쿼리
    with connections['default'].cursor() as cur:
        query = '''
            select count(*)
            from tbl_price_history x
            join tbl_user y
            on x.user_id = y.id
            {wc}
        '''.format(wc=wc)
        cur.execute(query)
        rows = cur.fetchall()
        total = rows[0][0]
        # print('DEBUG -> total : ', total)

    # 데이터테이블즈 - 메인 쿼리
    with connections['default'].cursor() as cur:
        query = '''
            select  x.id,
            		x.tid,
            		x.pgcode,
            		x.product_name,
            		x.krw as krw,
            		x.usd as usd,
            		x.cny as cny,
            		x.taxfree_amount,
            		x.tax_amount,
            		y.email,
            		x.autopay_flag,
            		x.refund_yn,
            		x.regist_date,
            		x.refund_date,
            		x.auto_end_date,
                    concat(x.id, '+', x.refund_yn, '+', x.pgcode) as refund
            from tbl_price_history x
            join tbl_user y
            on x.user_id = y.id
            {wc}
            order by {orderby_col} {orderby_opt}
            limit {start}, 10
        '''.format(
            wc=wc,
            orderby_col=column_name[orderby_col],
            orderby_opt=orderby_opt,
            start=start,
            end=start+length-1
        )
        cur.execute(query)
        rows = dictfetchall(cur)

    ret = {
        "recordsTotal": total,
        "recordsFiltered": total,
        "draw": draw,
        "data": rows
    }
    return JsonResponse(ret)


# (2020-03-18)
@allow_admin
def api_update_refund(request):

    # 파라미터 로드
    id = request.POST.get('id')

    # 결제 테이블 조회
    tph = TblPriceHistory.objects.get(id=id)
    krw = tph.krw
    usd = tph.usd
    cny = tph.cny
    tid = tph.tid
    user_id = tph.user_id
    pgcode = tph.pgcode
    
    session = str(tph.session)
    month_type = str(tph.month_type)
    user_id = tph.user_id
    
    # 파라미터 로깅
    print('DEBUG -> id : ', id)
    print('DEBUG -> krw : ', krw)
    print('DEBUG -> usd : ', usd)
    print('DEBUG -> cny : ', cny)
    print('DEBUG -> tid : ', tid)
    print('DEBUG -> user_id : ', user_id)
    print('DEBUG -> pgcode : ', pgcode)

    # 사용자 객체
    user = TblUser.objects.get(id=user_id)
    email = user.email

    # 국내환불
    if krw != None:
        p = Payletter(settings.PAYLETTER_MODE)
        res = p.payments_cancel(pgcode, user_id, tid, krw)
        # 환불 성공
        if res == 200:
            tph.refund_yn = 'Y'
            tph.refund_date = datetime.datetime.now()
            tph.save()
            #initServiceTime(user_id)
            print("National Refund: ", "TRUE")
            refundPayment(user_id, session, month_type)
            title, text = get_swal('PAYMENT_SUCCESS')
            return JsonResponse({'result': 200, 'title': title, 'text': text})
        else:
            # 환불 실패
            title, text = get_swal('PAYMENT_ERROR')
            return JsonResponse({'result': 500, 'title': title, 'text': text})
    # 해외환불
    elif usd != None:
        p = PayletterGlobal(settings.PAYLETTER_MODE)
        res = p.payments_cancel(pgcode, user_id, tid, usd)
        # 환불 성공
        if res == 200:
            tph.refund_yn = 'Y'
            tph.refund_date = datetime.datetime.now()
            tph.save()
            #initServiceTime(user_id)
            print("National Refund: ", "FALSE")
            refundPayment(user_id, session, month_type)
            title, text = get_swal('PAYMENT_SUCCESS')
            return JsonResponse({'result': 200, 'title': title, 'text': text})
        elif res == 400:
            # 환불 실패 (이미 처리된 트랜잭션)
            title, text = get_swal('PAYMENT_ALREADY')
            return JsonResponse({'result': 500, 'title': title, 'text': text})
        else:
            # 환불 실패
            title, text = get_swal('PAYMENT_ERROR')
            return JsonResponse({'result': 500, 'title': title, 'text': text})
    # 위챗환불
    elif cny != None:
        p = Paybox(settings.PAYBOX_MODE)
        token = p.load_token()
        if token != 500:
            res = p.payments_cancel(pgcode, user_id, tid, cny, token)
            # 환불성공
            if res != 500:
                tph.refund_yn = 'Y'
                tph.refund_date = datetime.datetime.now()
                tph.save()
                #initServiceTime(user_id)
                refundPayment(user_id, session, month_type)
                title, text = get_swal('PAYMENT_SUCCESS')
                return JsonResponse({'result': 200, 'title': title, 'text': text})
            else:
                title, text = get_swal('PAYMENT_ERROR')
                return JsonResponse({'result': 500, 'title': title, 'text': text})
        else:
            title, text = get_swal('PAYMENT_ERROR')
            return JsonResponse({'result': 500, 'title': title, 'text': text})
    else:
        title, text = get_swal('PAYMENT_UNKNOWN')
        return JsonResponse({'result': 500, 'title': title, 'text': text})


# (2020-03-18)
@allow_admin
def api_update_account(request):
    person_name = request.POST.get('person_name')
    bank_name = request.POST.get('bank_name')
    bank_number = request.POST.get('bank_number')
    try:
        bank = TblBankAccount.objects.get(type='main')
        bank.person_name = person_name
        bank.bank_name = bank_name
        bank.bank_number = bank_number
        bank.save()
        title, text = get_swal('SUCCESS_ACCOUNT')
        return JsonResponse({'result': 200, 'title': title, 'text': text})
    except BaseException as err:
        title, text = get_swal('UNKNOWN_ERROR')
        return JsonResponse({'result': 500, 'title': title, 'text': text})



# (2020-03-18)
@allow_admin
def api_read_account(request):
    try:
        bank = TblBankAccount.objects.get(type='main')
        person_name = bank.person_name
        bank_name = bank.bank_name
        bank_number = bank.bank_number
        send = {
            'person_name': person_name,
            'bank_name': bank_name,
            'bank_number': bank_number
        }
        return JsonResponse({'result': 200, 'bank': send})
    except BaseException as err:
        title, text = get_swal('UNKNOWN_ERROR')
        return JsonResponse({'result': 500, 'title': title, 'text': text})


# (2020-03-18)
@allow_admin
def api_read_ready_count(request):
    history = TblSendHistory.objects.filter(status='R')
    ready_count = len(history)
    return JsonResponse({'result': 200, 'ready_count': ready_count})


# (2020-03-18)
@allow_admin
def api_read_bank(request):

    # datatables 기본 파라미터
    start = int(request.POST.get('start'))
    length = int(request.POST.get('length'))
    draw = int(request.POST.get('draw'))
    orderby_col = int(request.POST.get('order[0][column]'))
    orderby_opt = request.POST.get('order[0][dir]')

    # 검색필터 파라미터
    number = request.POST.get('number')
    email = request.POST.get('email')
    username = request.POST.get('username')
    session = request.POST.get('session')
    month = request.POST.get('month')
    status = request.POST.get('status')
    regist_start = request.POST.get('regist_start')
    regist_end = request.POST.get('regist_end')

    # 로깅 (datatables 기본 파라미터)
    #print('DEBUG -> start : ', start)
    #print('DEBUG -> length : ', length)
    #print('DEBUG -> draw : ', draw)
    #print('DEBUG -> orderby_col : ', orderby_col)
    #print('DEBUG -> orderby_opt : ', orderby_opt)

    # 로깅 (검색필터 파라미터)
    #print('DEBUG -> number : ', number)
    #print('DEBUG -> email : ', email)
    #print('DEBUG -> username : ', username)
    #print('DEBUG -> session : ', session)
    #print('DEBUG -> month : ', month)
    #print('DEBUG -> status : ', status)
    #print('DEBUG -> regist_start : ', regist_start)
    #print('DEBUG -> regist_end : ', regist_end)

    # where 절 필터링 생성
    wc = ' where 1=1 '
    if number != '':
        wc += " and x.id = '{number}' ".format(number=number)
    if email != '':
        wc += " and y.email like '%{email}%' ".format(email=email)
    if username != '':
        wc += " and y.username like '%{username}%' ".format(username=username)
    if session != '0':
        wc += " and x.session = '{session}' ".format(session=session)
    if month != '0':
        wc += " and x.month_type = '{month}' ".format(month=month)
    if status != '0':
        wc += " and x.status = '{status}' ".format(status=status)
    if regist_start != '':
        wc += '''
            and x.regist_date >= '{regist_start}'
        '''.format(regist_start=regist_start)
    if regist_end != '':
        wc += '''
            and x.regist_date < '{regist_end}'
        '''.format(regist_end=regist_end)

    # order by 리스트
    column_name = [
        'x.id',
        'y.email',
        'y.username',
        'x.session',
        'x.month_type',
        'x.krw'
    ]

    # 데이터테이블즈 - 카운팅 쿼리
    with connections['default'].cursor() as cur:
        query = '''
            select count(*)
            from tbl_send_history x
            join tbl_user y
            on x.user_id = y.id
            {wc}
        '''.format(wc=wc)
        cur.execute(query)
        rows = cur.fetchall()
        total = rows[0][0]
        # print('DEBUG -> total : ', total)

    # 데이터테이블즈 - 메인 쿼리
    with connections['default'].cursor() as cur:
        query = '''
            select  x.id,
            		y.email,
            		y.username,
                    DATE_FORMAT(y.regist_date, "%Y-%m-%d %H:%i:%S") as regist_date,
                    DATE_FORMAT(x.regist_date, "%Y-%m-%d %H:%i:%S") as request_date,
            		x.session,
            		x.month_type,
            		x.krw,
            		x.status as status,
            		concat(x.status, '@', x.id, '@', y.username, '@', x.product_name, '@', x.krw) as cancel,
                    DATE_FORMAT(x.cancel_date, "%Y-%m-%d %H:%i:%S") as cancel_date,
            		concat(x.status, '&', x.id, '&', y.username, '&', x.product_name, '&', x.krw, '&', x.session, '&', y.email, '&', y.black_yn) as accept,
                    DATE_FORMAT(x.accept_date, "%Y-%m-%d %H:%i:%S") as accept_date,
            		concat(x.status, '@', x.id, '@', y.username, '@', x.product_name, '@', x.krw) as refund,
                    DATE_FORMAT(x.refund_date, "%Y-%m-%d %H:%i:%S") as refund_date,
            		x.type
            from tbl_send_history x
            join tbl_user y
            on x.user_id = y.id
            {wc}
            order by {orderby_col} {orderby_opt}
            limit {start}, 10
        '''.format(
            wc=wc,
            orderby_col=column_name[orderby_col],
            orderby_opt=orderby_opt,
            start=start
        )
        cur.execute(query)
        rows = dictfetchall(cur)

    ret = {
        "recordsTotal": total,
        "recordsFiltered": total,
        "draw": draw,
        "data": rows
    }
    return JsonResponse(ret)


# (2020-03-18)
@allow_admin
def api_create_bank(request):
    note_email = request.POST.get('note_email')
    note_session = request.POST.get('note_session')
    note_month = request.POST.get('note_month')
    note_type = request.POST.get('note_type')

    print("note_email -> ", note_email)
    print("note_session -> ", note_session)
    print("note_month -> ", note_month)
    print("note_type -> ", note_type)

    try:
        user = TblUser.objects.get(email=note_email)
    except BaseException as err:
        title, text = get_swal('NOT_USER')
        return JsonResponse({'result': 500, 'title': title, 'text': text})
        
    price = getProductPirce(note_session, note_month, 'KRW')
    product_name = makeProductName(note_session, note_month)

    try:
        sh = TblSendHistory(
            user_id = user.id,
            product_name = product_name,
            session = note_session,
            month_type = note_month,
            krw = price,
            usd = None,
            jpy = None,
            cny = None,
            status = 'R',
            type = note_type,
            regist_date = datetime.datetime.now(),
            accept_date = None,
            cancel_date = None,
            refund_date = None)
        sh.save()
        title, text = get_swal('SUCCESS_BANK')
        return JsonResponse({'result': 200, 'title': title, 'text': text})
    except BaseException as err:
        title, text = get_swal('UNKNOWN_ERROR')
        return JsonResponse({'result': 500, 'title': title, 'text': text})


# (2020-03-18)
@allow_admin
def api_update_bank(request):
    id = request.POST.get('id')
    type = request.POST.get('type')
    try:
        history = TblSendHistory.objects.get(id=id)
        session = str(history.session)
        month_type = str(history.month_type)
        user_id = history.user_id

        history.status = type
        if type == 'C':
            history.cancel_date = datetime.datetime.now()
        elif type == 'A':
            history.accept_date = datetime.datetime.now()
            # 시간충전
            giveServiceTime(user_id, session, month_type)
        elif type == 'Z':
            history.refund_date = datetime.datetime.now()
            # 시간초기화
            #initServiceTime(user_id)
            refundPayment(user_id, session, month_type)
        history.save()

        title, text = get_swal('SUCCESS_COMMON')
        return JsonResponse({'result': 200, 'title': title, 'text': text})
    except BaseException as err:
        title, text = get_swal('UNKNOWN_ERROR')
        return JsonResponse({'result': 500, 'title': title, 'text': text})

# (2022-08-08)
def refundPayment(user_id, session, month_type):
    # 유저객체 획득
    print("================ User Refund ===============", "")
    u1 = TblUser.objects.get(id = user_id)
    email = u1.email

    # Radcheck의 session 변경 (merge 로직)
    rc = Radcheck.objects.using('radius').filter(
        username = email,
        attribute = 'Simultaneous-Use'
    )

    print("Email               ====> ", email)
    # Radcheck의 time 변경 (merge 로직)
    rce = Radcheck.objects.using('radius').filter(
        username = email,
        attribute = 'Expiration'
    )
    my_time = my_expire_time(email, 'datetime')
    print("My Time             ====> ", my_time)
    if len(rce) == 0:
        rcei = Radcheck(
            username = email,
            attribute = 'Expiration',
            op = ':=',
            value = '01 Jan 2010 00:00:00 KST'
        )
        rcei.save(using='radius')
        prev_time = ''
        prev_time_rad = ''
    else:
        if my_time > datetime.datetime.now():
            rcu = rc.first()
            if int(rcu.value) == 1:
                if int(session) == 1:
                    add_time = get_old_time(my_time, month_type)
                    print("Deleted Months        ====> ", month_type)
                elif int(session) == 2:
                    new_days = int(int(month_type) * 30.4 * 140 / 83) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 3:
                    new_days = int(int(month_type) * 30.4 * 220 / 83) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 4:
                    new_days = int(int(month_type) * 30.4 * 280 / 83) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 5:
                    new_days = int(int(month_type) * 30.4 * 350 / 83) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 6:
                    new_days = int(int(month_type) * 30.4 * 433 / 83) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
            elif int(rcu.value) == 2:
                if int(session) == 1:
                    new_days = int(int(month_type) * 30.4 * 83 / 140) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 2:
                    add_time = get_old_time(my_time, month_type)
                    print("Deleted Months        ====> ", month_type)
                elif int(session) == 3:
                    new_days = int(int(month_type) * 30.4 * 220 / 140) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 4:
                    new_days = int(int(month_type) * 30.4 * 280 / 140) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 5:
                    new_days = int(int(month_type) * 30.4 * 350 / 140) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 6:
                    new_days = int(int(month_type) * 30.4 * 433 / 140) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
            elif int(rcu.value) == 3:
                if int(session) == 1:
                    new_days = int(int(month_type) * 30.4 * 83 / 220) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 2:
                    new_days = int(int(month_type) * 30.4 * 140 / 220) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 3:
                    add_time = get_old_time(my_time, month_type)
                    print("Deleted Months        ====> ", month_type)
                elif int(session) == 4:
                    new_days = int(int(month_type) * 30.4 * 280 / 220) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 5:
                    new_days = int(int(month_type) * 30.4 * 350 / 220) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 6:
                    new_days = int(int(month_type) * 30.4 * 433 / 220) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
            elif int(rcu.value) == 4:
                if int(session) == 1:
                    new_days = int(int(month_type) * 30.4 * 83 / 280) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 2:
                    new_days = int(int(month_type) * 30.4 * 140 / 280) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 3:
                    new_days = int(int(month_type) * 30.4 * 220 / 280) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 4:
                    add_time = get_old_time(my_time, month_type)
                    print("Deleted Months        ====> ", month_type)
                elif int(session) == 5:
                    new_days = int(int(month_type) * 30.4 * 350 / 280) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 6:
                    new_days = int(int(month_type) * 30.4 * 433 / 280) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
            elif int(rcu.value) == 5:
                if int(session) == 1:
                    new_days = int(int(month_type) * 30.4 * 83 / 350) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 2:
                    new_days = int(int(month_type) * 30.4 * 140 / 350) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 3:
                    new_days = int(int(month_type) * 30.4 * 220 / 350) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 4:
                    new_days = int(int(month_type) * 30.4 * 280 / 350) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 5:
                    add_time = get_old_time(my_time, month_type)
                    print("Deleted Months        ====> ", month_type)
                elif int(session) == 6:
                    new_days = int(int(month_type) * 30.4 * 433 / 350) 
                    add_time = get_time_other_session(my_time, new_days)
            elif int(rcu.value) == 6:
                if int(session) == 1:
                    new_days = int(int(month_type) * 30.4 * 83 / 433) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 2:
                    new_days = int(int(month_type) * 30.4 * 140 / 433) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 3:
                    new_days = int(int(month_type) * 30.4 * 220 / 433) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 4:
                    new_days = int(int(month_type) * 30.4 * 280 / 433) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                elif int(session) == 6:
                    add_time = get_old_time(my_time, month_type)
                    print("Deleted Months        ====> ", month_type)
                elif int(session) == 5:
                    new_days = int(int(month_type) * 30.4 * 350 / 433) 
                    add_time = get_time_other_session(my_time, new_days)
                    print("Deleted Days        ====> ", new_days)
                
            print("User Session        ====> ", rcu.value)
            print("Refund Session        ====> ", session)
            
            print("New Time            ====> ", add_time)
            rceu = rce.first()
            prev_time_rad = rceu.value
            prev_time = dec_radius_time(rceu.value)
            after_time = add_time
            after_time_rad = change_date(add_time)
            
            rceu.value = change_date(add_time)
            rceu.save(using='radius')
        else :
            print("Expired             ====> ", "TRUE")
            rceu = rce.first()
            prev_time_rad = rceu.value
            prev_time = dec_radius_time(rceu.value)
            after_time = '2010-01-01 00:00:00'
            after_time_rad = '01 Jan 2010 00:00:00 KST'
            
            rceu.value = '01 Jan 2010 00:00:00 KST'
            rceu.save(using='radius')
            
    #time_diff = after_time - prev_time
    #time_diff = round((time_diff).total_seconds()/60)
    
    reason = "환불"
    st = TblServiceTime(
        user_id = user_id,
        prev_time = prev_time,
        prev_time_rad = prev_time_rad,
        after_time = after_time,
        after_time_rad = after_time_rad,
        diff = reason,
        reason = reason,
        regist_date = datetime.datetime.now())
    st.save()
    
    print("=============== User Refund END ============", "")
    

# (2022-08-08)
def change_date(old_date):
    try:
        return old_date.strftime("%d %b %Y %H:%M:%S") + " KST"
    except BaseException:
        return None

# (2022.08.08)
def my_expire_time(email, return_type):
    try:
        r = Radcheck.objects.using('radius').get(
            username=email,
            attribute='Expiration'
        )
        expire_time = r.value
        expire_time = dec_radius_time(expire_time)
        if return_type == 'datetime':
            return expire_time
        elif return_type == 'str':
            return expire_time.strftime("%Y-%m-%d %H:%M:%S")
    except BaseException:
        return None
        
# (2020-03-18)
@allow_admin
def api_read_ready_data(request):
    ready_list = ''
    history = TblSendHistory.objects.filter(status='R')
    total = len(history)
    for h in history:
        ready_list += str(h.id) + '  '
    return JsonResponse({'result': 200, 'ready_list': ready_list, 'total': total})

# (2020-03-18)
@allow_admin
def api_check_session(request):
    email = request.POST.get('email')
    session = request.POST.get('session')
    rc = Radcheck.objects.using('radius').filter(
        username = email,
        attribute = 'Simultaneous-Use'
    )
    if len(rc) == 0:
        print("New User")
        return JsonResponse({'result': 400})
    else:
        rcu = rc.first()
        if rcu.value != session :
            return JsonResponse({'result': 200, 'old_session':rcu.value})
        else :
            return JsonResponse({'result': 400})  